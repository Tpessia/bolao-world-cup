<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
    <script>
        $(function() {
            NewData('1', '1I5avuVF1MCJyDQAEk9lrflQsuA4q6wWoMiVqO6pKiT0');
        });

        function NewData(pages, ID) { //request spreadsheet page data
            id = ID; //cria id global
            pages = pages.split(',');

            pages.forEach(function (page, index) {

                var urlJSON = 'https://spreadsheets.google.com/feeds/cells/' + id + '/' + page + '/public/values?alt=json';

                $.ajax({ //verifica se a url existe
                    url: urlJSON,
                    dataType: 'html',
                    async: false,
                    timeout: 5000,
                    success: function (json) {
                        console.log(json);

                        data = JSON.parse(json).feed.entry //recebe a data como json

                        page = "page" + page; //cria a pageN

                        Arrayfy(page, true); //gera array (table.pageN.rowM[cell1,cell2,cell3])
                    },
                    error: function () {
                        alert("A conecção com o servidor foi interrompida, tente novamente!")
                    }
                });
            })
        }

        function Arrayfy(sheetPage, nullify = false) { //create an array based on the spreadsheet page
            if (typeof table == "undefined") {table = {}; }

            table[sheetPage] = {};

            var lastRow = 0;

            for (var i = 0; i < data.length; i++) {
                var dataTemp = data[i];

                if (!table[sheetPage]["row" + dataTemp.gs$cell.row]) {table[sheetPage]["row" + dataTemp.gs$cell.row] = []; } //create table.rowN

                if (lastRow != dataTemp.gs$cell.row) {lastCol = 0; } //new row

                if (dataTemp.gs$cell.col > lastCol && nullify) { //add null para células vazias
                    var holes = dataTemp.gs$cell.col - lastCol - 1; //number of emptys

                    for (var j = 0; j < holes; j++) {
                        table[sheetPage]["row" + dataTemp.gs$cell.row].push(null);
                    }
                }

                table[sheetPage]["row" + dataTemp.gs$cell.row].push(dataTemp.gs$cell.$t); //add value

                lastCol = dataTemp.gs$cell.col;
                lastRow = dataTemp.gs$cell.row;
            }
        }

        function PlayersArray() {
            players = [];

            j = 0;
            for (i in table.page1) {
                if (j > 1) {
                    pageVar = table.page1[i][3]; //sheet format (Página)
                    nameVar = table.page1[i][4]; //sheet format (Nome)
                    players.push({
                        page: pageVar,
                        name: nameVar
                    });
                }
                j++;
            }
        }

        function RankCreate() { //create ranking element

            $("body").html("Carregando...");

            PlayersArray();

            ranking = []; //array ranking (ranking[i].name; ranking[i].pontuacao)

            j = 0;

            for (i in table.page1) { //cria array do ranking
                if (j > 1) {
                        ranking.push({ name: table.page1[i][1], pontuacao: table.page1[i][2] });

                        for (k in players) { //player page passed to ranking array
                            if (ranking[j - 2].name == players[k].name) {
                                ranking[j - 2].page = players[k].page;
                            }
                        }
                    }
                j++;
            }

            $.ajax({
                url: "https://www.bolaodomauricio.xyz/assets/php/primeiros-insert.php?primeiro=" + ranking[0].name,
                method: "GET",
                success: function (data) {
                    console.log(data);
                    alert("Primeiros OK!");
                },
                error: function () {
                    alert("A conecção com o servidor foi interrompida, tente novamente!")
                }
            });

            $("body").html("Primeiro: " + ranking[0].name + "<br><br>")

            for (i in ranking) { $("body").html($("body").html() + (ParseInt(i) + 1) + " " + ranking[i].name + " " + ranking[i].pontuacao + "<br>") }

            total = 0;
            for (i in ranking) {
                ranking[i].name = LowerClean(ranking[i].name) + "_" + ranking[i].page;

                total += ParseInt(ranking[i].pontuacao); 
            }
            media = (total / ranking.length).toFixed(2);

            // var params = { "ranking": ranking };
            paramsJSON = JSON.stringify(ranking);
            console.log("https://www.bolaodomauricio.xyz/assets/php/ranking-insert.php?ranking=" + paramsJSON + "&media=" + media);

            $.ajax({
                url: "https://www.bolaodomauricio.xyz/assets/php/ranking-insert.php?ranking=" + paramsJSON + "&media=" + media,
                method: "GET",
                // data: paramsJSON,
                success: function(data) {
                    console.log(data);
                    alert("Media e Dados Gerais OK!");
                },
                error: function () {
                    alert("A conecção com o servidor foi interrompida, tente novamente!")
                }
            });
        }

        function LowerClean(str) {
            var lower = str.toLowerCase();
            var upper = str.toUpperCase();

            var res = "";
            for (var i = 0; i < lower.length; ++i) {
                if (lower[i] != upper[i] || lower[i].trim() === '')
                    res += str[i];
            }

            return res/*.replace(/ã|Ã|á|Á|â|Â|à|À|ä|Ä/g, "a").replace(/é|É|ê|Ê|è|È|ë|Ë/g, "e").replace(/í|Í|î|Î|ì|Ì|ï|Ï/g, "i").replace(/õ|Õ|ó|Ó|ô|Ô|ò|Ò|ö|Ö/g, "o").replace(/ú|Ú|û|Û|ù|Ù|ü|Ü/g, "u").replace(/ñ/g, "n")*/.replace(/¹/g, "1").replace(/²/g, "2").replace(/³/g, "3").replace(/ç/g, "c").replace(/ª/g, "a").replace(/°|º/g, "o").replace(/^-|-$|@+|#+|\$+|%+|&+|\*+|\++|´+|`+|¨+|\^+|!+|\?+|'+|"+|~+|£+|¢+|¬+|<+|>+|®+/g, "").replace(/0-9/g, "").replace(/ /g, "_");
        }
    </script>
</head>
<body>
    <button id="genData">Gerar novos dados!</button>

    <!-- <button id="clearLast">Limpar último conjunto de dados!</button> -->
    <script>
        $("#genData").on("click", function () {
            RankCreate();
        });

        $("#clearLast").on("click", function () {
            if(window.confirm("Você realmente deseja remover todos os dados do último conjunto?")) {
                $.ajax({
                    url: "https://www.bolaodomauricio.xyz/assets/php/clear-last.php",
                    method: "GET",
                    success: function (data) {
                        $("body").html(data);
                    },
                    error: function () {
                        alert("A conecção com o servidor foi interrompida, tente novamente!")
                    }
                });
            }
        });
    </script>
</body>
</html>